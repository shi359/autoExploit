import os
import json
import sys                                                                                                                                    
import getopt
from util import *
from Scanner import Scanner
from Msgrpc import Msgrpc
from Metasploit import Metasploit

def parseArg(argv):
    targetHost = ''
    nmapFile = ''
    keyword = ''
    try:
        opts, args = getopt.getopt(argv,"ha:n:k:")
    except getopt.GetoptError:
        print ('fetch.py -a <targetIP> -n <nmapResult> -k <payload keyword>')
        sys.exit(2)

    for opt,arg in opts:
        if opt == '-h':
            print ('fetch.py -a <targetIP> -n <nmapResult>')
        elif opt == '-a':
            targetHost = arg
        elif opt == '-n':
            nmapFile = arg
        elif opt == '-k':
            keyword = arg

    return targetHost, nmapFile, keyword


if __name__ == "__main__":

    targetHost, nmapFile,keyword = parseArg(sys.argv[1:])
    config = readConfig()
    if not targetHost:
        print(RED+"Target host file required!"+ENDC)
        sys.exit(1)
    
    scanner = Scanner(targetHost,config['Nmap'])
    if not nmapFile:
        print(RED+"No nmap file found. Start scanning..."+ENDC)
        hostInfo = scanner.scan()
    else:    
        full_path = os.path.dirname(os.path.abspath(__file__))
        f = os.path.join(full_path, nmapFile)
        hostInfo = scanner.readFromFile(f)

    do_exploit = Metasploit(config['Exploit'], scanner)
    for host, info in hostInfo.items():
        do_exploit.exploit(host, info, keyword)
    print(OKBLUE+"End up exploitation!"+ENDC)
